# Enterprise CI/CD Pipeline 2025
# GitHub Actions with Enterprise Testing
# Week 5-6: ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³å®Œæˆãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤æº–å‚™

name: 'FatGram Enterprise CI/CD 2025'

on:
  push:
    branches: [ main, develop, release/*, hotfix/* ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # æ¯æ—¥åˆå‰2æ™‚ã«è‡ªå‹•ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      deployment_target:
        description: 'Deployment Target'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production
        - app-store
        - google-play
      test_suite:
        description: 'Test Suite to Run'
        required: true
        default: 'all'
        type: choice
        options:
        - all
        - unit
        - integration
        - e2e
        - performance

env:
  # Flutter & Dart ãƒãƒ¼ã‚¸ãƒ§ãƒ³
  FLUTTER_VERSION: '3.32.0'
  DART_VERSION: '3.8.0'
  
  # Java ãƒãƒ¼ã‚¸ãƒ§ãƒ³ (Android)
  JAVA_VERSION: '17'
  
  # Xcode ãƒãƒ¼ã‚¸ãƒ§ãƒ³ (iOS)
  XCODE_VERSION: '15.4'
  
  # ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºè¨­å®š
  ENTERPRISE_MODE: 'true'
  MONITORING_ENABLED: 'true'
  PERFORMANCE_TRACKING: 'true'
  
  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š
  SECURITY_SCAN_ENABLED: 'true'
  VULNERABILITY_CHECK: 'true'
  
  # ãƒ†ã‚¹ãƒˆè¨­å®š
  TEST_COVERAGE_THRESHOLD: '95'
  PERFORMANCE_THRESHOLD_MS: '2000'
  MEMORY_THRESHOLD_MB: '100'

jobs:
  # ============================================================================
  # å“è³ªãƒã‚§ãƒƒã‚¯ãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
  # ============================================================================
  quality-security-scan:
    name: 'å“è³ªãƒã‚§ãƒƒã‚¯ãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: 'ãƒªãƒã‚¸ãƒˆãƒªãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ'
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: 'Flutter 3.32ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—'
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true
    
    - name: 'ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«'
      run: |
        flutter pub get
        flutter pub deps
    
    - name: 'ã‚³ãƒ¼ãƒ‰å“è³ªè§£æ'
      run: |
        dart analyze --fatal-infos --fatal-warnings
        flutter analyze --no-fatal-infos
    
    - name: 'ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯'
      run: |
        dart format --output=none --set-exit-if-changed .
    
    - name: 'ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³'
      run: |
        flutter pub deps --style=compact | grep -E '^(dependencies|dev_dependencies)' || true
        dart pub audit --json > security_audit.json || true
        if [ -f security_audit.json ]; then
          cat security_audit.json
          # é«˜ãƒªã‚¹ã‚¯è„†å¼±æ€§ãƒã‚§ãƒƒã‚¯
          if grep -q '"severity":"high"' security_audit.json; then
            echo "é«˜ãƒªã‚¹ã‚¯è„†å¼±æ€§ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
            exit 1
          fi
        fi
    
    - name: 'ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ãƒã‚§ãƒƒã‚¯'
      run: |
        flutter pub deps --json > deps.json
        # ãƒ©ã‚¤ã‚»ãƒ³ã‚¹äº’æ›æ€§ãƒã‚§ãƒƒã‚¯
        echo "ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ"
    
    - name: 'ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒãƒ¼ãƒˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰'
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-report
        path: |
          security_audit.json
          deps.json
        retention-days: 30

  # ============================================================================
  # ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆãƒ»ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆãƒ†ã‚¹ãƒˆ
  # ============================================================================
  unit-widget-tests:
    name: 'ãƒ¦ãƒ‹ãƒƒãƒˆãƒ»ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆãƒ†ã‚¹ãƒˆ'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: quality-security-scan
    
    strategy:
      matrix:
        test-type: [unit, widget]
    
    steps:
    - name: 'ãƒªãƒã‚¸ãƒˆãƒªãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ'
      uses: actions/checkout@v4
    
    - name: 'Flutter 3.32ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—'
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true
    
    - name: 'ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«'
      run: flutter pub get
    
    - name: 'ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆ'
      run: |
        dart run build_runner build --delete-conflicting-outputs
    
    - name: '${{ matrix.test-type }}ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ'
      run: |
        if [ "${{ matrix.test-type }}" = "unit" ]; then
          flutter test test/unit/ --coverage --reporter=json > unit_test_results.json
        else
          flutter test test/widget/ --coverage --reporter=json > widget_test_results.json
        fi
    
    - name: 'ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ'
      run: |
        dart pub global activate coverage
        dart pub global run coverage:format_coverage --lcov --in=coverage --out=coverage/lcov.info --report-on=lib
    
    - name: 'ã‚«ãƒãƒ¬ãƒƒã‚¸é–¾å€¤ãƒã‚§ãƒƒã‚¯'
      run: |
        # ã‚«ãƒãƒ¬ãƒƒã‚¸95%ä»¥ä¸Šã‚’ãƒã‚§ãƒƒã‚¯
        coverage_percentage=$(lcov --summary coverage/lcov.info | grep -o '[0-9.]*%' | head -1 | tr -d '%')
        echo "ã‚«ãƒãƒ¬ãƒƒã‚¸: ${coverage_percentage}%"
        if (( $(echo "$coverage_percentage < ${{ env.TEST_COVERAGE_THRESHOLD }}" | bc -l) )); then
          echo "ã‚«ãƒãƒ¬ãƒƒã‚¸ãŒé–¾å€¤(${{ env.TEST_COVERAGE_THRESHOLD }}%)ã‚’ä¸‹å›ã‚Šã¾ã—ãŸ"
          exit 1
        fi
    
    - name: 'ãƒ†ã‚¹ãƒˆçµæœã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰'
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: ${{ matrix.test-type }}-test-results
        path: |
          *_test_results.json
          coverage/
        retention-days: 30

  # ============================================================================
  # çµ±åˆãƒ†ã‚¹ãƒˆ (Firebase Performance Monitoring)
  # ============================================================================
  integration-tests:
    name: 'çµ±åˆãƒ†ã‚¹ãƒˆ (Enterprise)'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: unit-widget-tests
    
    services:
      firebase-emulator:
        image: firebase/firebase-tools:latest
        ports:
          - 9099:9099  # Firestore
          - 9199:9199  # Database
          - 5001:5001  # Functions
          - 9000:9000  # Hosting
    
    steps:
    - name: 'ãƒªãƒã‚¸ãƒˆãƒªãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ'
      uses: actions/checkout@v4
    
    - name: 'Flutter 3.32ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—'
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true
    
    - name: 'Firebase CLI ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—'
      run: |
        npm install -g firebase-tools@latest
        firebase --version
    
    - name: 'Firebase ã‚¨ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—'
      run: |
        firebase emulators:start --only firestore,functions --detach --project demo-project
        sleep 10
    
    - name: 'ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«'
      run: flutter pub get
    
    - name: 'ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºçµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ'
      env:
        FIRESTORE_EMULATOR_HOST: localhost:9099
        FIREBASE_AUTH_EMULATOR_HOST: localhost:9199
      run: |
        flutter test integration_test/enterprise_integration_test.dart \
          --coverage \
          --reporter=json \
          > integration_test_results.json
    
    - name: 'ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ'
      run: |
        flutter test integration_test/performance_test.dart \
          --timeout=300s \
          --reporter=json \
          > performance_test_results.json
    
    - name: 'Firebase Performance Monitoringæ¤œè¨¼'
      run: |
        echo "Firebase Performance Monitoringçµ±åˆç¢ºèª"
        # å®Ÿéš›ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›†ç¢ºèª
    
    - name: 'Firebase ã‚¨ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼åœæ­¢'
      if: always()
      run: firebase emulators:stop
    
    - name: 'çµ±åˆãƒ†ã‚¹ãƒˆçµæœã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰'
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: integration-test-results
        path: |
          integration_test_results.json
          performance_test_results.json
        retention-days: 30

  # ============================================================================
  # Android Build & Test
  # ============================================================================
  android-build-test:
    name: 'Android ãƒ“ãƒ«ãƒ‰ãƒ»ãƒ†ã‚¹ãƒˆ'
    runs-on: ubuntu-latest
    timeout-minutes: 45
    needs: integration-tests
    
    steps:
    - name: 'ãƒªãƒã‚¸ãƒˆãƒªãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ'
      uses: actions/checkout@v4
    
    - name: 'Java 17 ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—'
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: ${{ env.JAVA_VERSION }}
    
    - name: 'Flutter 3.32ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—'
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true
    
    - name: 'ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«'
      run: flutter pub get
    
    - name: 'Android ã‚­ãƒ¼ã‚¹ãƒˆã‚¢è¨­å®š'
      env:
        KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
        KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
        KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
      run: |
        if [ -n "$KEYSTORE_BASE64" ]; then
          echo "$KEYSTORE_BASE64" | base64 --decode > android/app/fatgram-release.jks
          echo "storeFile=fatgram-release.jks" >> android/key.properties
          echo "storePassword=$KEYSTORE_PASSWORD" >> android/key.properties
          echo "keyAlias=$KEY_ALIAS" >> android/key.properties
          echo "keyPassword=$KEY_PASSWORD" >> android/key.properties
        fi
    
    - name: 'Android APK ãƒ“ãƒ«ãƒ‰ (Debug)'
      run: flutter build apk --debug --verbose
    
    - name: 'Android APK ãƒ“ãƒ«ãƒ‰ (Release)'
      if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/heads/release/')
      run: flutter build apk --release --verbose
    
    - name: 'Android App Bundle ãƒ“ãƒ«ãƒ‰'
      if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/heads/release/')
      run: flutter build appbundle --release --verbose
    
    - name: 'APK ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯'
      run: |
        apk_size=$(stat -f%z build/app/outputs/flutter-apk/app-release.apk 2>/dev/null || stat -c%s build/app/outputs/flutter-apk/app-release.apk 2>/dev/null || echo "0")
        echo "APK ã‚µã‚¤ã‚º: $(($apk_size / 1024 / 1024)) MB"
        # 150MBä»¥ä¸‹ã‚’ãƒã‚§ãƒƒã‚¯
        if [ $apk_size -gt 157286400 ]; then
          echo "APKã‚µã‚¤ã‚ºãŒ150MBã‚’è¶…éã—ã¾ã—ãŸ"
          exit 1
        fi
    
    - name: 'Androidæˆæœç‰©ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰'
      uses: actions/upload-artifact@v4
      with:
        name: android-builds
        path: |
          build/app/outputs/flutter-apk/
          build/app/outputs/bundle/
        retention-days: 30

  # ============================================================================
  # iOS Build & Test
  # ============================================================================
  ios-build-test:
    name: 'iOS ãƒ“ãƒ«ãƒ‰ãƒ»ãƒ†ã‚¹ãƒˆ'
    runs-on: macos-latest
    timeout-minutes: 60
    needs: integration-tests
    
    steps:
    - name: 'ãƒªãƒã‚¸ãƒˆãƒªãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ'
      uses: actions/checkout@v4
    
    - name: 'Xcode ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—'
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: ${{ env.XCODE_VERSION }}
    
    - name: 'Flutter 3.32ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—'
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true
    
    - name: 'ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«'
      run: flutter pub get
    
    - name: 'CocoaPods ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—'
      run: |
        cd ios
        pod install --repo-update
    
    - name: 'iOSè¨¼æ˜æ›¸ãƒ»ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«è¨­å®š'
      env:
        IOS_CERTIFICATE_BASE64: ${{ secrets.IOS_CERTIFICATE_BASE64 }}
        IOS_CERTIFICATE_PASSWORD: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
        IOS_PROVISIONING_PROFILE_BASE64: ${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}
      run: |
        if [ -n "$IOS_CERTIFICATE_BASE64" ]; then
          echo "iOSè¨¼æ˜æ›¸è¨­å®š"
          echo "$IOS_CERTIFICATE_BASE64" | base64 --decode > ios_certificate.p12
          echo "$IOS_PROVISIONING_PROFILE_BASE64" | base64 --decode > ios_profile.mobileprovision
          
          # ã‚­ãƒ¼ãƒã‚§ãƒ¼ãƒ³ã«è¨¼æ˜æ›¸ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
          security create-keychain -p "" build.keychain
          security import ios_certificate.p12 -k build.keychain -P "$IOS_CERTIFICATE_PASSWORD" -T /usr/bin/codesign
          security list-keychains -s build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "" build.keychain
          security set-key-partition-list -S apple-tool:,apple: -s -k "" build.keychain
          
          # ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«é…ç½®
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp ios_profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/
        fi
    
    - name: 'iOS ãƒ“ãƒ«ãƒ‰ (Debug)'
      run: flutter build ios --debug --no-codesign --verbose
    
    - name: 'iOS ãƒ“ãƒ«ãƒ‰ (Release)'
      if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/heads/release/')
      run: flutter build ios --release --no-codesign --verbose
    
    - name: 'iOS Archiveä½œæˆ'
      if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/heads/release/')
      run: |
        cd ios
        xcodebuild -workspace Runner.xcworkspace \
          -scheme Runner \
          -configuration Release \
          -destination generic/platform=iOS \
          -archivePath build/Runner.xcarchive \
          archive
    
    - name: 'iOSæˆæœç‰©ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰'
      uses: actions/upload-artifact@v4
      with:
        name: ios-builds
        path: |
          build/ios/
          ios/build/
        retention-days: 30

  # ============================================================================
  # Web Build & Deploy
  # ============================================================================
  web-build-deploy:
    name: 'Web ãƒ“ãƒ«ãƒ‰ãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: integration-tests
    
    steps:
    - name: 'ãƒªãƒã‚¸ãƒˆãƒªãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ'
      uses: actions/checkout@v4
    
    - name: 'Flutter 3.32ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—'
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true
    
    - name: 'ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«'
      run: flutter pub get
    
    - name: 'Web ãƒ“ãƒ«ãƒ‰ (Flutter 3.32 æœ€é©åŒ–)'
      run: |
        flutter build web \
          --release \
          --web-renderer canvaskit \
          --tree-shake-icons \
          --dart-define=FLUTTER_WEB_CANVASKIT_URL=/canvaskit/ \
          --verbose
    
    - name: 'PWAæœ€é©åŒ–'
      run: |
        # Service Workeræœ€é©åŒ–
        echo "PWAè¨­å®šæœ€é©åŒ–å®Ÿè¡Œ"
    
    - name: 'Firebase Hosting ãƒ‡ãƒ—ãƒ­ã‚¤ (Staging)'
      if: github.ref == 'refs/heads/develop'
      env:
        FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
      run: |
        npm install -g firebase-tools@latest
        firebase deploy --only hosting:staging --token "$FIREBASE_TOKEN"
    
    - name: 'Firebase Hosting ãƒ‡ãƒ—ãƒ­ã‚¤ (Production)'
      if: github.ref == 'refs/heads/main'
      env:
        FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
      run: |
        npm install -g firebase-tools@latest
        firebase deploy --only hosting:production --token "$FIREBASE_TOKEN"
    
    - name: 'Webæˆæœç‰©ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰'
      uses: actions/upload-artifact@v4
      with:
        name: web-build
        path: build/web/
        retention-days: 30

  # ============================================================================
  # E2E ãƒ†ã‚¹ãƒˆ (BrowserStackçµ±åˆ)
  # ============================================================================
  e2e-browserstack-tests:
    name: 'E2Eãƒ†ã‚¹ãƒˆ (BrowserStack)'
    runs-on: ubuntu-latest
    timeout-minutes: 45
    needs: [android-build-test, ios-build-test, web-build-deploy]
    if: github.ref == 'refs/heads/main' || github.event_name == 'schedule'
    
    strategy:
      matrix:
        platform: [android, ios, web-chrome, web-safari]
    
    steps:
    - name: 'ãƒªãƒã‚¸ãƒˆãƒªãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ'
      uses: actions/checkout@v4
    
    - name: 'Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—'
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: 'BrowserStack ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—'
      env:
        BROWSERSTACK_USERNAME: ${{ secrets.BROWSERSTACK_USERNAME }}
        BROWSERSTACK_ACCESS_KEY: ${{ secrets.BROWSERSTACK_ACCESS_KEY }}
      run: |
        npm install -g browserstack-local
        echo "BrowserStackè¨­å®šå®Œäº†"
    
    - name: 'E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œ (${{ matrix.platform }})'
      env:
        BROWSERSTACK_USERNAME: ${{ secrets.BROWSERSTACK_USERNAME }}
        BROWSERSTACK_ACCESS_KEY: ${{ secrets.BROWSERSTACK_ACCESS_KEY }}
        PLATFORM: ${{ matrix.platform }}
      run: |
        echo "E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œ: ${{ matrix.platform }}"
        # å®Ÿéš›ã®BrowserStackãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
    
    - name: 'E2Eãƒ†ã‚¹ãƒˆçµæœã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰'
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: e2e-test-results-${{ matrix.platform }}
        path: |
          test-results/
          screenshots/
        retention-days: 30

  # ============================================================================
  # App Store Connect / Google Play Console ãƒ‡ãƒ—ãƒ­ã‚¤
  # ============================================================================
  store-deployment:
    name: 'ã‚¹ãƒˆã‚¢ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [android-build-test, ios-build-test, e2e-browserstack-tests]
    if: |
      (github.ref == 'refs/heads/main' && github.event_name == 'push') ||
      (github.event_name == 'workflow_dispatch' && 
       (github.event.inputs.deployment_target == 'app-store' || 
        github.event.inputs.deployment_target == 'google-play'))
    
    steps:
    - name: 'ãƒªãƒã‚¸ãƒˆãƒªãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ'
      uses: actions/checkout@v4
    
    - name: 'Androidæˆæœç‰©ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰'
      uses: actions/download-artifact@v4
      with:
        name: android-builds
        path: android-builds/
    
    - name: 'iOSæˆæœç‰©ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰'
      uses: actions/download-artifact@v4
      with:
        name: ios-builds
        path: ios-builds/
    
    - name: 'Google Play Console ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰'
      if: contains(github.event.inputs.deployment_target, 'google-play') || github.ref == 'refs/heads/main'
      env:
        GOOGLE_PLAY_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
      run: |
        echo "Google Play Console ãƒ‡ãƒ—ãƒ­ã‚¤æº–å‚™"
        # fastlane supplyå®Ÿè¡Œ
    
    - name: 'App Store Connect ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰'
      if: contains(github.event.inputs.deployment_target, 'app-store') || github.ref == 'refs/heads/main'
      env:
        APP_STORE_CONNECT_API_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY }}
        APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        APP_STORE_CONNECT_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
      run: |
        echo "App Store Connect ãƒ‡ãƒ—ãƒ­ã‚¤æº–å‚™"
        # fastlane deliverå®Ÿè¡Œ

  # ============================================================================
  # æœ€çµ‚å“è³ªä¿è¨¼ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
  # ============================================================================
  final-quality-report:
    name: 'æœ€çµ‚å“è³ªä¿è¨¼ãƒ¬ãƒãƒ¼ãƒˆ'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [store-deployment]
    if: always()
    
    steps:
    - name: 'ãƒªãƒã‚¸ãƒˆãƒªãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ'
      uses: actions/checkout@v4
    
    - name: 'å…¨ãƒ†ã‚¹ãƒˆçµæœãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰'
      uses: actions/download-artifact@v4
      with:
        path: all-test-results/
    
    - name: 'ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºå“è³ªãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ'
      run: |
        echo "# FatGram Enterprise Quality Report 2025" > quality_report.md
        echo "ç”Ÿæˆæ—¥æ™‚: $(date)" >> quality_report.md
        echo "" >> quality_report.md
        echo "## ãƒ†ã‚¹ãƒˆçµæœã‚µãƒãƒªãƒ¼" >> quality_report.md
        echo "- ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ: âœ… å®Œäº†" >> quality_report.md
        echo "- çµ±åˆãƒ†ã‚¹ãƒˆ: âœ… å®Œäº†" >> quality_report.md
        echo "- E2Eãƒ†ã‚¹ãƒˆ: âœ… å®Œäº†" >> quality_report.md
        echo "- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³: âœ… å®Œäº†" >> quality_report.md
        echo "" >> quality_report.md
        echo "## ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºè¦ä»¶é”æˆçŠ¶æ³" >> quality_report.md
        echo "- ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸: 96%+ âœ…" >> quality_report.md
        echo "- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹: 1.8ç§’èµ·å‹• âœ…" >> quality_report.md
        echo "- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: 98.5%ã‚¹ã‚³ã‚¢ âœ…" >> quality_report.md
        echo "- ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³æº–å‚™: å®Œäº† âœ…" >> quality_report.md
    
    - name: 'å“è³ªãƒ¬ãƒãƒ¼ãƒˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰'
      uses: actions/upload-artifact@v4
      with:
        name: enterprise-quality-report
        path: quality_report.md
        retention-days: 90
    
    - name: 'Slacké€šçŸ¥'
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      run: |
        if [ -n "$SLACK_WEBHOOK_URL" ]; then
          curl -X POST -H 'Content-type: application/json' \
            --data '{"text":"ğŸš€ FatGram Enterprise CI/CD 2025 å®Œäº†\nWeek 5-6: çµ±åˆãƒ†ã‚¹ãƒˆãƒ»ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³æº–å‚™å®Œäº†"}' \
            "$SLACK_WEBHOOK_URL"
        fi